<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="user-scalable=no" />
    <title>Traffic</title>
    <style type="text/css">
      html,
      body,
      div,
      a,
      canvas {
        margin: 0;
        padding: 0;
        border: 0;
      }
      html {
        height: 100%;
        overflow: hidden;
      }
      body {
        position: relative;
        height: 100%;
        background: #777;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: moz-none;
        -ms-user-select: none;
        user-select: none;
      }
      body.day {
        background: #777;
      }
      body.night {
        background: #222;
      }
      #screen {
        position: fixed;
        left: 0;
        top: 0;
        width: 1008px;
        height: 648px;
      }
      #twitter {
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="fs">
      <canvas
        id="screen"
        width="1008"
        height="648"
        class="hide"
        moz-opaque
      ></canvas>
    </div>
    <a href="" id="twitter" target="twitter"></a>
    <script type="text/javascript">
      function SfxrParams() {
        this.setSettings = function (e) {
          for (var t = 0; 24 > t; t++)
            this[String.fromCharCode(97 + t)] = e[t] || 0;
          0.01 > this.c && (this.c = 0.01);
          e = this.b + this.c + this.e;
          0.18 > e &&
            ((e = 0.18 / e), (this.b *= e), (this.c *= e), (this.e *= e));
        };
      }
      function SfxrSynth() {
        this._params = new SfxrParams();
        var e, t, n, r, i, s, o, u, a, f, l, c;
        this.reset = function () {
          var e = this._params;
          r = 100 / (e.f * e.f + 0.001);
          i = 100 / (e.g * e.g + 0.001);
          s = 1 - 0.01 * e.h * e.h * e.h;
          o = 1e-6 * -e.i * e.i * e.i;
          e.a || ((l = 0.5 - e.n / 2), (c = 5e-5 * -e.o));
          u = 0 < e.l ? 1 - 0.9 * e.l * e.l : 1 + 10 * e.l * e.l;
          a = 0;
          f = 1 == e.m ? 0 : 2e4 * (1 - e.m) * (1 - e.m) + 32;
        };
        this.totalReset = function () {
          this.reset();
          var r = this._params;
          e = 1e5 * r.b * r.b;
          t = 1e5 * r.c * r.c;
          n = 1e5 * r.e * r.e + 10;
          return (e + t + n) | 0;
        };
        this.synthWave = function (h, p) {
          var v = this._params,
            y = 1 != v.s || v.v,
            b = 0.1 * v.v * v.v,
            w = 1 + 3e-4 * v.w,
            E = 0.1 * v.s * v.s * v.s,
            S = 1 + 1e-4 * v.t,
            x = 1 != v.s,
            T = v.x * v.x,
            N = v.g,
            C = v.q || v.r,
            k = 0.2 * v.r * v.r * v.r,
            O = v.q * v.q * (0 > v.q ? -1020 : 1020),
            _ = v.p ? ((2e4 * (1 - v.p) * (1 - v.p)) | 0) + 32 : 0,
            D = v.d,
            P = v.j / 2,
            H = 0.01 * v.k * v.k,
            B = v.a,
            j = e,
            F = 1 / e,
            I = 1 / t,
            q = 1 / n,
            v = (5 / (1 + 20 * v.u * v.u)) * (0.01 + E);
          0.8 < v && (v = 0.8);
          for (
            var v = 1 - v,
              R = !1,
              U = 0,
              W = 0,
              X = 0,
              V = 0,
              $ = 0,
              Q,
              G = 0,
              Y,
              Z = 0,
              et,
              tt = 0,
              nt,
              rt = 0,
              it,
              st = 0,
              ot = Array(1024),
              ut = Array(32),
              at = ot.length;
            at--;

          )
            ot[at] = 0;
          for (at = ut.length; at--; ) ut[at] = 2 * Math.random() - 1;
          for (at = 0; at < p; at++) {
            if (R) return at;
            _ && ++rt >= _ && ((rt = 0), this.reset());
            f && ++a >= f && ((f = 0), (r *= u));
            s += o;
            r *= s;
            r > i && ((r = i), 0 < N && (R = !0));
            Y = r;
            0 < P && ((st += H), (Y *= 1 + Math.sin(st) * P));
            Y |= 0;
            8 > Y && (Y = 8);
            B || ((l += c), 0 > l ? (l = 0) : 0.5 < l && (l = 0.5));
            if (++W > j)
              switch (((W = 0), ++U)) {
                case 1:
                  j = t;
                  break;
                case 2:
                  j = n;
              }
            switch (U) {
              case 0:
                X = W * F;
                break;
              case 1:
                X = 1 + 2 * (1 - W * I) * D;
                break;
              case 2:
                X = 1 - W * q;
                break;
              case 3:
                (X = 0), (R = !0);
            }
            C &&
              ((O += k),
              (et = O | 0),
              0 > et ? (et = -et) : 1023 < et && (et = 1023));
            y && w && ((b *= w), 1e-5 > b ? (b = 1e-5) : 0.1 < b && (b = 0.1));
            it = 0;
            for (var ft = 8; ft--; ) {
              Z++;
              if (Z >= Y && ((Z %= Y), 3 == B))
                for (Q = ut.length; Q--; ) ut[Q] = 2 * Math.random() - 1;
              switch (B) {
                case 0:
                  nt = Z / Y < l ? 0.5 : -0.5;
                  break;
                case 1:
                  nt = 1 - 2 * (Z / Y);
                  break;
                case 2:
                  nt = Z / Y;
                  nt = 0.5 < nt ? 6.28318531 * (nt - 1) : 6.28318531 * nt;
                  nt =
                    0 > nt
                      ? 1.27323954 * nt + 0.405284735 * nt * nt
                      : 1.27323954 * nt - 0.405284735 * nt * nt;
                  nt =
                    0 > nt
                      ? 0.225 * (nt * -nt - nt) + nt
                      : 0.225 * (nt * nt - nt) + nt;
                  break;
                case 3:
                  nt = ut[Math.abs(((32 * Z) / Y) | 0)];
              }
              y &&
                ((Q = G),
                (E *= S),
                0 > E ? (E = 0) : 0.1 < E && (E = 0.1),
                x ? (($ += (nt - G) * E), ($ *= v)) : ((G = nt), ($ = 0)),
                (G += $),
                (V += G - Q),
                (nt = V *= 1 - b));
              C &&
                ((ot[tt % 1024] = nt),
                (nt += ot[(tt - et + 1024) % 1024]),
                tt++);
              it += nt;
            }
            it = 0.125 * it * X * T;
            h[at] = 1 <= it ? 32767 : -1 >= it ? -32768 : (32767 * it) | 0;
          }
          return p;
        };
      }
      function TrafficCar(e) {
        this.id = game.cars.length;
        this.out = false;
        this.type = UTIL.rnd(3) - 1;
        this.state = "accelerate";
        this.turn = false;
        this.needRefreshImage = false;
        this.speed = 2;
        this.angerLevel = 0;
        this.peakAngerLevel = 0;
        this.turnDelay = { left: false, right: false };
        this.index = { left: false, right: false };
        this.lastPath = { crossroad: false, in: false, direction: false };
        this.canvas = {};
        this.context = {};
        var t = UTIL.getEntryPointPixels(e);
        this.x = t.x;
        this.y = t.y;
        this.r = (e.d - 1) * 90;
        this.canvas.car = document.createElement("canvas");
        this.canvas.car.width = 40;
        this.canvas.car.height = 40;
        this.context.car = this.canvas.car.getContext("2d");
        this.canvas.painted = document.createElement("canvas");
        this.canvas.painted.width = 15;
        this.canvas.painted.height = 25;
        this.context.painted = this.canvas.painted.getContext("2d");
        var n = game.carsSpriteData[this.type];
        var r = this.context.painted.createImageData(15, 25);
        var i = DATA.carColors[UTIL.rnd(8) - 1];
        for (var s = 0, o = n.length; s < o; s += 4) {
          if (n[s] == 0 && n[s + 1] == 255) {
            r.data[s] = i[0];
            r.data[s + 1] = i[1];
            r.data[s + 2] = i[2];
          } else if (n[s] == 0 && n[s + 1] == 170) {
            r.data[s] = i[0] - 50;
            r.data[s + 1] = i[1] - 50;
            r.data[s + 2] = i[2] - 50;
          } else {
            r.data[s] = n[s];
            r.data[s + 1] = n[s + 1];
            r.data[s + 2] = n[s + 2];
          }
          r.data[s + 3] = n[s + 3];
        }
        this.context.painted.putImageData(r, 0, 0);
        this.canvas.index = document.createElement("canvas");
        this.canvas.index.width = 40;
        this.canvas.index.height = 40;
        this.context.index = this.canvas.index.getContext("2d");
        var u = this.context.index.createRadialGradient(0, 0, 6, 0, 0, 20);
        u.addColorStop(0, "rgba(255, 255, 0, .8)");
        u.addColorStop(1, "rgba(255, 255, 0, .0)");
        this.context.index.fillStyle = u;
        this.canvas.headlights = document.createElement("canvas");
        this.canvas.headlights.width = 40;
        this.canvas.headlights.height = 40;
        this.context.headlights = this.canvas.headlights.getContext("2d");
        this.refreshCarImage = function () {
          this.context.car.save();
          this.context.car.clearRect(0, 0, 40, 40);
          this.context.car.translate(20, 20);
          this.context.car.rotate((this.r * Math.PI) / 180);
          this.context.car.drawImage(
            this.canvas.painted,
            0,
            0,
            15,
            25,
            -8,
            -12,
            15,
            25
          );
          this.context.car.restore();
          this.context.index.save();
          this.context.index.clearRect(0, 0, 40, 40);
          this.context.index.translate(20, 20);
          this.context.index.rotate((this.r * Math.PI) / 180);
          if (this.index.left) {
            this.context.index.beginPath();
            this.context.index.arc(-9, -10, 5, 0, Math.PI * 2);
            this.context.index.arc(-9, 11, 5, 0, Math.PI * 2);
            this.context.index.fill();
          } else if (this.index.right) {
            this.context.index.beginPath();
            this.context.index.arc(7, -10, 5, 0, Math.PI * 2);
            this.context.index.arc(7, 11, 5, 0, Math.PI * 2);
            this.context.index.fill();
          }
          this.context.index.restore();
          this.context.headlights.save();
          this.context.headlights.clearRect(0, 0, 40, 40);
          this.context.headlights.translate(20, 20);
          this.context.headlights.rotate((this.r * Math.PI) / 180);
          var e = this.context.headlights.createRadialGradient(
            0,
            0,
            6,
            0,
            0,
            20
          );
          e.addColorStop(0, "rgba(255, 255, 255, .8)");
          e.addColorStop(1, "rgba(255, 255, 255, .0)");
          this.context.headlights.fillStyle = e;
          this.context.headlights.beginPath();
          this.context.headlights.arc(-6, -16, 8, 0, Math.PI * 2);
          this.context.headlights.arc(5, -16, 8, 0, Math.PI * 2);
          this.context.headlights.fill();
          this.context.headlights.fillStyle = "#f33";
          this.context.headlights.beginPath();
          this.context.headlights.arc(-5, 12, 1, 0, Math.PI * 2);
          this.context.headlights.arc(5, 12, 1, 0, Math.PI * 2);
          this.context.headlights.fill();
          this.context.headlights.restore();
        };
        this.refreshCarImage();
        this.generatePath = function (e, t) {
          if (this.lastPath.crossroad == e) return;
          var n = game.trafficLights[e];
          var r;
          var i;
          do {
            r = ["straight", "left", "right"][UTIL.rnd(3) - 1];
          } while (!n[DATA.deniedDirections[r][t]]);
          this.lastPath = { crossroad: e, in: t, d: r };
          if (r == "left") this.index.left = true;
          else if (r == "right") this.index.right = true;
          this.needRefreshImage = true;
        };
        this.animationRoutine = function () {
          engine.canvas.drawImage(this.canvas.car, this.x - 15, this.y - 15);
        };
        this.animateIndex = function () {
          if (engine.animationFrameCounter % 12 < 6)
            engine.canvas.drawImage(
              this.canvas.index,
              this.x - 15,
              this.y - 15
            );
        };
        this.animateHeadlights = function () {
          engine.canvas.drawImage(
            this.canvas.headlights,
            this.x - 15,
            this.y - 15
          );
        };
        this.scanRoutine = function () {
          var e = false;
          var t = UTIL.getCarFrontArea(this.r, this.x, this.y);
          for (var n = 0; n < game.cars.length; n++) {
            var r = game.cars[n];
            if (r.out) continue;
            if (r.x == this.x && r.y == this.y) continue;
            var i =
              r.r >= 330 || r.r < 30 || (r.r >= 150 && r.r < 210) ? 8 : 16;
            var s =
              (r.r >= 70 && r.r < 110) || (r.r >= 250 && r.r < 290) ? 8 : 16;
            if (i == 16 && s == 16) {
              i = 11;
              s = 11;
            }
            if (
              UTIL.collision(
                t[0],
                t[1],
                t[2],
                t[3],
                r.x + 4 - i,
                r.y + 4 - s,
                i * 2,
                s * 2
              )
            ) {
              var o =
                this.r >= 330 || this.r < 30 || (this.r >= 150 && this.r < 210)
                  ? 8
                  : 16;
              var u =
                (this.r >= 70 && this.r < 110) ||
                (this.r >= 250 && this.r < 290)
                  ? 8
                  : 16;
              if (o == 16 && u == 16) {
                o = 11;
                u = 11;
              }
              var a = UTIL.getCarFrontArea(r.r, r.x, r.y);
              var f = UTIL.collision(
                a[0],
                a[1],
                a[2],
                a[3],
                this.x + 4 - o,
                this.y + 4 - u,
                o * 2,
                u * 2
              )
                ? true
                : false;
              e = true;
              if (f) {
                if (this.r % 90 === 0) e = false;
                else if (this.id < r.id) e = false;
              }
            }
            if (e) break;
          }
          if (e) this.state = "brake";
          else if (this.state != "crossroad") this.state = "accelerate";
          for (var l in game.trafficLights) {
            var c = l.split("x");
            var h = +c[0];
            var p = +c[1];
            if (
              (this.r == 0 &&
                this.x == h * 72 + 45 &&
                (this.y == p * 72 + 90 || this.y == p * 72 + 91)) ||
              (this.r == 180 &&
                this.x == h * 72 + 17 &&
                (this.y == p * 72 - 30 || this.y == p * 72 - 31)) ||
              (this.r == 90 &&
                this.y == p * 72 + 45 &&
                (this.x == h * 72 - 30 || this.x == h * 72 - 31)) ||
              (this.r == 270 &&
                this.y == p * 72 + 17 &&
                (this.x == h * 72 + 90 || this.x == h * 72 + 91))
            ) {
              this.generatePath(l, this.r);
              if (
                game.trafficLights[l][[180, 270, 0, 90].indexOf(this.r)] ==
                "red"
              )
                this.state = "crossroad";
              else this.crossroadPrecedence(l);
            }
          }
          if (this.state == "accelerate") this.speed = 2;
          else if (this.state == "brake" || this.state == "crossroad")
            this.speed = 0;
          if (this.turn) {
            this.needRefreshImage = true;
            if (this.speed > 0) {
              if (this.turnDelay[this.turn] === false)
                this.turnDelay[this.turn] = 0;
              if (this.turnDelay[this.turn] !== false)
                this.turnDelay[this.turn]++;
              if (this.turnDelay[this.turn] > (this.turn == "left" ? 22 : 9)) {
                if (this.turn == "left") {
                  this.r -= 4;
                  if (this.r < 0) this.r = 360 + this.r;
                } else {
                  this.r += 4;
                  if (this.r > 360) this.r = this.r - 360;
                }
                if (Math.round((this.r % 90) * 100) / 100 < 4) this.endTurn();
              }
            }
          }
          if (this.needRefreshImage) {
            this.needRefreshImage = false;
            this.refreshCarImage();
          }
          var d = Math.sin((this.r * Math.PI) / 180);
          var v = -Math.cos((this.r * Math.PI) / 180);
          this.y += v * this.speed;
          this.x += d * this.speed;
          this.y = Math.round(this.y);
          this.x = Math.round(this.x);
          if (
            (this.r == 0 && this.y < -30) ||
            (this.r == 90 && this.x > 1010) ||
            (this.r == 180 && this.y > 650) ||
            (this.r == 270 && this.x < -30)
          ) {
            this.out = true;
            game.carsOut++;
            if (this.peakAngerLevel < 300) game.score += 3;
            else if (this.peakAngerLevel < 500) game.score += 2;
            else if (this.peakAngerLevel < 700) game.score += 1;
          }
          if (!this.out) {
            this.speed == 0 ? this.angerLevel++ : this.angerLevel--;
            if (this.angerLevel < 0) this.angerLevel = 0;
            else if (this.angerLevel > 1e3) this.angerLevel = 1e3;
            if (this.angerLevel > this.peakAngerLevel)
              this.peakAngerLevel = this.angerLevel;
          }
        };
        this.crossroadPrecedence = function (e) {
          var t = e.split("x");
          var n = [];
          for (var r = 0; r < 16; r++) n[r] = false;
          for (var i = 0; i < 16; i++) {
            if (i % 3 == 0) continue;
            var s = (i % 4) * 36 - 36;
            var o = Math.floor(i / 4) * 36 - 36;
            var u = false;
            for (var r = 0; r < game.cars.length; r++) {
              var a = game.cars[r];
              if (
                a.out ||
                a.id == this.id ||
                (a.lastPath.crossroad == this.lastPath.crossroad &&
                  a.lastPath["in"] == this.lastPath["in"] &&
                  a.state == "accelerate")
              )
                continue;
              var f =
                a.r >= 330 || a.r < 30 || (a.r >= 150 && a.r < 210) ? 8 : 16;
              var l =
                (a.r >= 70 && a.r < 110) || (a.r >= 250 && a.r < 290) ? 8 : 16;
              if (f == 16 && l == 16) {
                f = 11;
                l = 11;
              }
              if (
                UTIL.collision(
                  a.x + 4 - f,
                  a.y + 4 - l,
                  f * 2,
                  l * 2,
                  +t[0] * 72 + s,
                  +t[1] * 72 + o,
                  36,
                  36
                )
              ) {
                u = true;
                break;
              }
            }
            if (u) n[i] = true;
          }
          var c = this.lastPath.d;
          var h = DATA.crossroadMatrix[c][this.r];
          var p = false;
          for (var r = 0; r < h.length; r++) if (n[h[r]]) p = true;
          if (p) this.state = "crossroad";
          else {
            this.state = "accelerate";
            this.turn = c == "straight" ? false : c;
          }
        };
        this.endTurn = function () {
          this.turn = false;
          var e = Math.floor(this.x / 72);
          var t = Math.floor(this.y / 72);
          if (this.r > 350 || this.r < 10) {
            this.x = e * 72 + 45;
            this.r = 0;
          } else if (this.r > 80 && this.r < 100) {
            this.y = t * 72 + 45;
            this.r = 90;
          } else if (this.r > 170 && this.r < 190) {
            this.x = e * 72 + 17;
            this.r = 180;
          } else if (this.r > 260 && this.r < 280) {
            this.y = t * 72 + 17;
            this.r = 270;
          }
          this.index = { left: false, right: false };
          this.turnDelay = { left: false, right: false };
        };
      }
      function TrafficGame() {
        this.city = "paris";
        this.scene = "menu";
        this.time = "day";
        this.frameCounters = { level: 0, timeSwitch: 0, touchstart: 0 };
        this.init = function () {
          this.setImages();
          this.setCity("paris");
        };
        this.resetVariables = function () {
          this.trafficLights = {};
          this.cars = [];
          this.carsIn = 0;
          this.carsOut = 0;
          this.carFrequency = 26;
          this.score = 0;
          this.weightedAngerLevel = 0;
          this.gameOver = false;
          this.entryPoints = [];
          this.frameCounters.level = 0;
          this.frameCounters.timeSwitch = 0;
          this.lastSoundTime = 0;
          this.hover = { element: false, newElement: false };
        };
        this.setImages = function () {
          function e(e) {
            var t = e.getAttribute("num");
            var n = document.createElement("canvas");
            n.width = 15;
            n.height = 25;
            var r = n.getContext("2d");
            r.drawImage(game.carImages[t], 0, 0);
            game.carsSpriteData[t] = r.getImageData(0, 0, 15, 25).data;
          }
          this.carImages = [];
          this.carsSpriteData = [];
          for (var t = 0; t < 3; t++) {
            this.carImages[t] = UTIL.imageBySprite("car" + (t + 1));
            this.carImages[t].setAttribute("num", t);
            this.carImages[t].onload = function () {
              e(this);
            };
          }
          this.buildings = [];
          for (var t = 1; t <= 5; t++)
            this.buildings[t] = UTIL.imageBySprite("building" + t);
          this.treeImage = UTIL.imageBySprite("tree");
          this.waterImage = UTIL.imageBySprite("water");
          this.concreteImage = UTIL.imageBySprite("concrete");
        };
        this.setCity = function (e) {
          this.resetVariables();
          this.city = e;
          UTIL.playSound("clickButton");
          for (var t = 0; t < 9; t++) {
            for (var n = 0; n < 14; n++) {
              var r = DATA.cities[e].map[t][n];
              if (r in { i: 1, j: 1, k: 1, l: 1, m: 1 }) {
                var i = n + "x" + t;
                var s = r == "m" ? false : "red";
                var o = r == "j" ? false : "green";
                var u = r == "i" ? false : "red";
                var a = r == "l" ? false : "green";
                this.trafficLights[i] = [s, o, u, a];
              }
              var f = 0;
              if (t == 0 && r == "v") f = 3;
              if (t == 8 && r == "v") f = 1;
              if (n == 0 && r == "h") f = 2;
              if (n == 13 && r == "h") f = 4;
              if (f) this.entryPoints.push({ x: n, y: t, d: f, cars: 0 });
            }
          }
        };
        this.switchLight = function (e) {
          if (!(e in this.trafficLights)) return;
          for (var t = 0; t < 4; t++) {
            var n = this.trafficLights[e][t];
            if (n === false) continue;
            this.trafficLights[e][t] = n == "red" ? "green" : "red";
          }
        };
        this.switchTime = function (e) {
          this.time = e;
          document.body.setAttribute("class", e);
          this.frameCounters.timeSwitch = 60;
        };
        this.tweetScore = function () {
          var e =
            "I just reached " +
            this.score +
            " points in " +
            DATA.cities[this.city].name +
            "! http://traffic.krissz.hu/";
          document
            .getElementById("twitter")
            .setAttribute(
              "href",
              "https://twitter.com/intent/tweet?text=" + encodeURIComponent(e)
            );
          document.getElementById("twitter").click();
        };
        this.animationRoutine = function () {
          engine.animationFrameCounter++;
          for (var e = 0; e < 9; e++) {
            for (var t = 0; t < 14; t++) {
              var n = DATA.cities[this.city].map[e][t];
              var r = +n;
              var i = t * 72;
              var s = e * 72;
              if (r > 0) {
                if (r == 1) UTIL.rect(i, s, 72, 72, 13);
                if (r == 2) UTIL.rect(i, s, 72, 72, 5);
                if (r == 3) engine.canvas.drawImage(this.concreteImage, i, s);
                if (r == 4) {
                  UTIL.rect(i, s, 72, 72, 6);
                  var o = engine.animationFrameCounter % 18;
                  if (o < 6) {
                    engine.canvas.drawImage(
                      this.waterImage,
                      0,
                      0,
                      40,
                      16,
                      i + 5,
                      s + 10,
                      40,
                      16
                    );
                    engine.canvas.drawImage(
                      this.waterImage,
                      40,
                      0,
                      40,
                      16,
                      i + 30,
                      s + 50,
                      40,
                      16
                    );
                  } else if (o < 12) {
                    engine.canvas.drawImage(
                      this.waterImage,
                      80,
                      0,
                      40,
                      16,
                      i + 5,
                      s + 10,
                      40,
                      16
                    );
                    engine.canvas.drawImage(
                      this.waterImage,
                      0,
                      0,
                      40,
                      16,
                      i + 30,
                      s + 50,
                      40,
                      16
                    );
                  } else {
                    engine.canvas.drawImage(
                      this.waterImage,
                      40,
                      0,
                      40,
                      16,
                      i + 5,
                      s + 10,
                      40,
                      16
                    );
                    engine.canvas.drawImage(
                      this.waterImage,
                      80,
                      0,
                      40,
                      16,
                      i + 30,
                      s + 50,
                      40,
                      16
                    );
                  }
                }
                if (r == 5) UTIL.rect(i, s, 72, 72, 7);
                if (r == 6) UTIL.rect(i, s, 72, 72, 3);
              } else {
                UTIL.rect(i, s, 72, 72, 11);
                if (n == "h" || n == "m") UTIL.rect(i, s + 9, 72, 2, 7);
                if (n == "h" || n == "i") UTIL.rect(i, s + 61, 72, 2, 7);
                if (n == "v" || n == "l") UTIL.rect(i + 9, s, 2, 72, 7);
                if (n == "v" || n == "j") UTIL.rect(i + 61, s, 2, 72, 7);
                if (n == "h")
                  for (var n = 0; n < 4; n++)
                    UTIL.rect(i - 5 + n * 24, s + 35, 10, 2, 7);
                if (n == "v")
                  for (var n = 0; n < 4; n++)
                    UTIL.rect(i + 35, s - 5 + n * 24, 2, 10, 7);
                engine.canvas.strokeStyle = "#" + DATA.colors[7];
                engine.canvas.lineWidth = 2;
                if (n == "i" || n == "j" || n == "k") {
                  UTIL.rect(i - 5, s + 35, 10, 2, 7);
                  UTIL.rect(i + 35, s - 5, 2, 10, 7);
                  engine.canvas.beginPath();
                  engine.canvas.arc(i, s, 10, 0, Math.PI / 2, false);
                  engine.canvas.stroke();
                }
                if (n == "j" || n == "m" || n == "k") {
                  UTIL.rect(i - 5, s + 35, 10, 2, 7);
                  engine.canvas.beginPath();
                  engine.canvas.arc(i, s + 72, 10, 0, Math.PI * 1.5, true);
                  engine.canvas.stroke();
                }
                if (n == "m" || n == "l" || n == "k") {
                  engine.canvas.beginPath();
                  engine.canvas.arc(
                    i + 72,
                    s + 72,
                    10,
                    Math.PI * 1.5,
                    Math.PI,
                    true
                  );
                  engine.canvas.stroke();
                }
                if (n == "l" || n == "i" || n == "k") {
                  UTIL.rect(i + 35, s - 5, 2, 10, 7);
                  engine.canvas.beginPath();
                  engine.canvas.arc(i + 72, s, 10, Math.PI, Math.PI / 2, true);
                  engine.canvas.stroke();
                }
              }
            }
          }
          for (var n = 0; n < this.cars.length; n++) {
            if (this.cars[n].out) continue;
            this.cars[n].animationRoutine();
          }
          for (var n = 0; n < DATA.cities[this.city].buildings.length; n++) {
            var u = DATA.cities[this.city].buildings[n];
            engine.canvas.drawImage(this.buildings[u[0]], u[1], u[2]);
          }
          for (var n = 0; n < DATA.cities[this.city].trees.length; n++) {
            var i = DATA.cities[this.city].trees[n][0];
            var s = DATA.cities[this.city].trees[n][1];
            var a = n % 4;
            if (a == 0) engine.canvas.drawImage(this.treeImage, i, s);
            if (a > 0) {
              engine.canvas.save();
              engine.canvas.translate(a == 2 ? 0 : 1008, a == 1 ? 0 : 648);
              engine.canvas.scale(a == 2 ? 1 : -1, a == 1 ? 1 : -1);
              engine.canvas.drawImage(
                this.treeImage,
                a == 2 ? i : 1008 - 60 - i,
                a == 1 ? s : 648 - 58 - s
              );
              engine.canvas.restore();
            }
          }
          engine.canvas.textAlign = "left";
          if (this.city == "paris") UTIL.drawText("P A R I S", 670, 330, 7, 18);
          if (this.city == "london")
            UTIL.drawText("L O N D O N", 3, 330, 8, 18);
          if (this.city == "roma") UTIL.drawText("R O M A", 888, 590, 7, 18);
          if (this.city == "sydney")
            UTIL.drawText("S Y D N E Y", 438, 80, 7, 18);
          if (this.city == "budapest")
            UTIL.drawText("B U D A P E S T", 600, 324, 14, 18);
          if (this.city == "newYork") {
            UTIL.drawText("N E W", 30, 55, 11, 18);
            UTIL.drawText("Y O R K", 18, 85, 11, 18);
          }
          var f =
            this.time == "day" && this.frameCounters.timeSwitch == 0
              ? false
              : true;
          if (f) {
            if (this.time == "night")
              var l = (60 - this.frameCounters.timeSwitch) / 100;
            else var l = this.frameCounters.timeSwitch / 100;
            engine.canvas.fillStyle = "rgba(0, 0, 0, " + l + ")";
            engine.canvas.fillRect(0, 0, 1008, 648);
          }
          for (var c in this.trafficLights) {
            var h = c.split("x");
            var i = +h[0] * 72;
            var s = +h[1] * 72;
            var p = [-24, 72, 72, -48];
            var d = [-48, -24, 72, 72];
            for (var n = 0; n < 4; n++) {
              var v = this.trafficLights[c][n];
              if (v === false) continue;
              var m = n % 2 ? "h" : "v";
              UTIL.rect(
                i + p[n],
                s + d[n],
                m == "h" ? 48 : 24,
                m == "v" ? 48 : 24,
                11
              );
              engine.canvas.fillStyle = "#" + DATA.colors[12];
              engine.canvas.beginPath();
              engine.canvas.arc(
                i + p[n] + 12,
                s + d[n] + 12,
                8,
                0,
                Math.PI * 2
              );
              engine.canvas.arc(
                i + p[n] + (m == "v" ? 12 : 36),
                s + d[n] + (m == "h" ? 12 : 36),
                8,
                0,
                Math.PI * 2
              );
              engine.canvas.fill();
              if (f) {
                engine.canvas.fillStyle = "rgba(0, 0, 0, " + l + ")";
                engine.canvas.fillRect(
                  i + p[n],
                  s + d[n],
                  m == "h" ? 48 : 24,
                  m == "v" ? 48 : 24
                );
              }
              if (
                ((n == 0 || n == 3) && v == "green") ||
                ((n == 1 || n == 2) && v == "red")
              ) {
                var g = i + p[n] + 12;
                var y = s + d[n] + 12;
              } else if (
                ((n == 0 || n == 3) && v == "red") ||
                ((n == 1 || n == 2) && v == "green")
              ) {
                var g = i + p[n] + (m == "v" ? 12 : 36);
                var y = s + d[n] + (m == "h" ? 12 : 36);
              }
              var b = engine.canvas.createRadialGradient(g, y, 6, g, y, 20);
              if (v == "green") {
                b.addColorStop(0, "rgba(100, 255, 100, 1)");
                b.addColorStop(0.6, "rgba(100, 255, 100, 0)");
              } else if (v == "red") {
                b.addColorStop(0, "rgba(255, 100, 100, 1)");
                b.addColorStop(0.6, "rgba(255, 100, 100, 0)");
              }
              engine.canvas.fillStyle = b;
              engine.canvas.beginPath();
              engine.canvas.arc(g, y, f ? 15 : 9, 0, Math.PI * 2);
              engine.canvas.fill();
            }
          }
          for (var n = 0; n < this.cars.length; n++) {
            if (this.cars[n].out) continue;
            if (this.cars[n].index.left || this.cars[n].index.right)
              this.cars[n].animateIndex();
            if (f) this.cars[n].animateHeadlights();
          }
          for (var n = 0; n < this.entryPoints.length; n++) {
            var w = this.entryPoints[n];
            if (w.cars < 2) continue;
            var E = UTIL.getEntryPointPixels(w);
            var i = engine.animationFrameCounter % 10;
            var S = i < 5 ? 7 : 10;
            var x = i < 5 ? 0 : 1;
            var p = [0, 27, 20, -49, -42];
            var d = [0, -34, 27, 20, -41];
            UTIL.rect(E.x + p[w.d], E.y + d[w.d], 32, 24, S);
            UTIL.drawText("+" + w.cars, E.x + p[w.d] + 3, E.y + d[w.d] + 17, x);
          }
          var p = DATA.cities[this.city].menuOffset[0];
          var d = DATA.cities[this.city].menuOffset[1];
          if (this.scene == "menu")
            var S = engine.animationFrameCounter % 10 < 5 ? 6 : 1;
          else var S = 10;
          var T = engine.animationFrameCounter % 10 < 5 ? 1 : 0;
          UTIL.rect(p + 80, d + 100, 130, 40, S);
          engine.canvas.textAlign = "center";
          UTIL.rect(868, 4, 136, 32, 6);
          UTIL.drawText("Day / Night", 936, 26, 1, 14, 90);
          UTIL.rect(868, 44, 136, 32, 6);
          UTIL.drawText("Screenshot", 936, 65, 1, 14, 90);
          UTIL.rect(868, 84, 136, 32, 6);
          UTIL.drawText("Fullscreen", 936, 104, 1, 14, 90);
          if (this.scene == "menu") {
            for (var n in DATA.cityButtons) {
              var u = DATA.cityButtons[n];
              UTIL.rect(
                p + u[0],
                d + u[1],
                u[2],
                u[3],
                this.city == n ? 2 : 10
              );
              UTIL.drawText(
                DATA.cities[n].name,
                p + u[0] + u[2] / 2,
                d + u[1] + 20,
                1,
                14,
                80
              );
            }
            UTIL.drawText("T R A F F I C", p + 145, d - 10, 1, 18, 170);
            UTIL.drawText("S T A R T", p + 145, d + 127, T, 18, 100);
          }
          if (this.scene == "game") {
            UTIL.drawText("E N D", p + 145, d + 127, 1, 18);
            if (this.gameOver) {
              UTIL.drawText("G A M E    O V E R", p + 145, d, 1, 18, 190);
              var S = engine.animationFrameCounter % 10 < 5 ? 6 : 1;
              UTIL.rect(p + 20, d + 50, 250, 40, S);
              UTIL.drawText("TWEET YOUR SCORE!", p + 145, d + 77, T, 18, 230);
            }
            engine.canvas.textAlign = "left";
            if (!this.gameOver) {
              UTIL.drawText("Anger level:", p, d, 1, 14, 85);
              for (var n = 0; n < 10; n++) {
                var N = 12;
                if (this.weightedAngerLevel > n) {
                  N = 10;
                  if (n <= 7) N = 7;
                  if (n <= 4) N = 5;
                }
                UTIL.rect(p + 95 + n * 21, d - 15, 20, 20, N);
              }
            }
            UTIL.rect(p + 95, d + 12, 100, 25, 6);
            UTIL.drawText("Score:", p, d + 30, 1);
            UTIL.drawText(this.score, p + 105, d + 30, 1);
          }
          var C = engine.hover.x;
          var k = engine.hover.y;
          this.hover.newElement = false;
          if (this.scene == "game") {
            if (!this.gameOver) {
              if (C !== false) {
                for (var L in this.trafficLights) {
                  var h = L.split("x");
                  var i = +h[0];
                  var s = +h[1];
                  if (
                    C >= i * 72 &&
                    C <= i * 72 + 72 &&
                    k >= s * 72 &&
                    k <= s * 72 + 72
                  )
                    UTIL.hoverArea(i * 72, s * 72, 72, 72, "crossroad");
                }
              }
            } else {
              if (C >= p + 20 && C <= p + 270 && k >= d + 50 && k <= d + 90)
                UTIL.hoverArea(p + 20, d + 50, 250, 40);
            }
          } else if (this.scene == "menu") {
            for (var n in DATA.cityButtons) {
              var u = DATA.cityButtons[n];
              if (
                C >= p + u[0] &&
                C <= p + u[0] + u[2] &&
                k >= d + u[1] &&
                k <= d + u[1] + u[3]
              )
                UTIL.hoverArea(p + u[0], d + u[1], u[2], u[3]);
            }
          }
          if (C >= 868 && C <= 1004 && k >= 4 && k <= 36)
            UTIL.hoverArea(868, 4, 136, 32);
          else if (C >= 868 && C <= 1004 && k >= 44 && k <= 76)
            UTIL.hoverArea(868, 44, 136, 32);
          else if (C >= 868 && C <= 1004 && k >= 84 && k <= 116)
            UTIL.hoverArea(868, 84, 136, 32);
          else if (C >= p + 80 && C <= p + 210 && k >= d + 100 && k <= d + 140)
            UTIL.hoverArea(p + 80, d + 100, 130, 40);
          if (this.hover.newElement != this.hover.element) {
            this.hover.element = this.hover.newElement;
            if (this.hover.element === false)
              engine.canvasElement.style.cursor = "default";
            else {
              if (
                this.hover.element != "crossroad" &&
                this.lastSoundTime + 100 < Date.now()
              )
                UTIL.playSound("hover");
              engine.canvasElement.style.cursor = "pointer";
            }
          }
        };
        this.scanRoutine = function () {
          engine.scanFrameCounter++;
          if (engine.click.x !== false) {
            this.scanMouseEvents(
              engine.click.x,
              engine.click.y,
              engine.click.btn
            );
            engine.click = { x: false, y: false, btn: false };
          }
          if (this.frameCounters.timeSwitch > 0)
            this.frameCounters.timeSwitch -= 2;
          if (this.frameCounters.touchstart > 0) {
            this.frameCounters.touchstart--;
            if (this.frameCounters.touchstart == 0) {
              engine.hover = { x: false, y: false };
              game.hover.element = false;
              game.hover.newElement = false;
            }
          }
          if (this.gameOver) return;
          this.frameCounters.level++;
          if (this.frameCounters.level % engine.scanFPS === 0) this.score++;
          if (
            this.scene == "game" &&
            this.carFrequency > 10 &&
            this.frameCounters.level % (30 * engine.scanFPS) === 0
          )
            this.carFrequency -= this.carFrequency > 18 ? 2 : 1;
          if (this.frameCounters.level % this.carFrequency === 0) {
            var e = UTIL.rnd(this.entryPoints.length) - 1;
            if (this.scene == "game" || this.entryPoints[e].cars == 0) {
              this.entryPoints[e].cars++;
              this.carsIn++;
            }
          }
          for (var t = 0; t < this.entryPoints.length; t++) {
            var n = this.entryPoints[t];
            if (n.cars == 0) continue;
            var r = UTIL.getEntryPointPixels(n);
            var i = false;
            for (var s = 0; s < this.cars.length; s++) {
              var o = this.cars[s];
              if (o.r != (n.d - 1) * 90) continue;
              if (
                (n.d == 1 && r.x == o.x && o.y > 628) ||
                (n.d == 2 && r.y == o.y && o.x < 20) ||
                (n.d == 3 && r.x == o.x && o.y < 20) ||
                (n.d == 4 && r.y == o.y && o.x > 988)
              )
                i = true;
              if (i) break;
            }
            if (!i) {
              n.cars--;
              this.cars.push(new TrafficCar(game.entryPoints[t]));
            }
          }
          if (this.scene == "menu" && this.frameCounters.level % 50 === 0) {
            var u = UTIL.rnd(Object.keys(game.trafficLights).length);
            var t = 0;
            for (var a in this.trafficLights) {
              t++;
              if (t == u) this.switchLight(a);
            }
          }
          for (var t = 0; t < this.cars.length; t++) {
            if (this.cars[t].out) continue;
            this.cars[t].scanRoutine();
          }
          if (
            this.frameCounters.level % 10 === 0 &&
            this.scene == "game" &&
            !this.gameOver
          ) {
            var f = 0;
            for (var t = 0; t < this.cars.length; t++) {
              if (this.cars[t].out) continue;
              var l = this.cars[t].angerLevel;
              if (l < 200) f += 0;
              else if (l < 400) f += 4;
              else if (l < 600) f += 8;
              else if (l < 800) f += 12;
              else f += 20;
            }
            var c = 0;
            for (var t = 0; t < this.entryPoints.length; t++) {
              c += this.entryPoints[t].cars;
              f += this.entryPoints[t].cars * 20;
            }
            this.weightedAngerLevel = Math.round(
              f / (this.carsIn + c - this.carsOut)
            );
            if (this.weightedAngerLevel >= 10) {
              this.gameOver = true;
              UTIL.playSound("gameOver");
            }
          }
        };
        this.scanMouseEvents = function (e, t, n) {
          var r = DATA.cities[this.city].menuOffset[0];
          var i = DATA.cities[this.city].menuOffset[1];
          if (this.scene == "game") {
            if (e >= r + 80 && e <= r + 210 && t >= i + 100 && t <= i + 140) {
              this.setCity(this.city);
              this.scene = "menu";
            } else if (!this.gameOver) {
              for (var s in this.trafficLights) {
                var o = s.split("x");
                var u = +o[0];
                var a = +o[1];
                if (
                  e >= u * 72 &&
                  e <= u * 72 + 72 &&
                  t >= a * 72 &&
                  t <= a * 72 + 72
                ) {
                  this.switchLight(s);
                  UTIL.playSound("switchLight");
                }
              }
            }
          } else if (this.scene == "menu") {
            for (var f in DATA.cityButtons) {
              var l = DATA.cityButtons[f];
              if (
                e >= r + l[0] &&
                e <= r + l[0] + l[2] &&
                t >= i + l[1] &&
                t <= i + l[1] + l[3] &&
                this.city != f
              )
                this.setCity(f);
            }
            if (e >= r + 80 && e <= r + 210 && t >= i + 100 && t <= i + 140) {
              this.setCity(this.city);
              this.scene = "game";
            }
          }
          if (
            e >= 868 &&
            e <= 1004 &&
            t >= 4 &&
            t <= 36 &&
            this.frameCounters.timeSwitch == 0
          ) {
            UTIL.playSound("clickButton");
            this.switchTime(this.time == "night" ? "day" : "night");
          }
        };
      }
      function TrafficEngine() {
        this.canvasElement = document.getElementById("screen");
        this.canvas = this.canvasElement.getContext("2d");
        this.click = { x: false, y: false, btn: false };
        this.hover = { x: false, y: false };
        this.scaleToFit = 1;
        this.platform = "desktop";
        this.display = "window";
        this.init = function () {
          var e = navigator.userAgent;
          this.platform =
            e.match(/Android/i) ||
            e.match(/BlackBerry/i) ||
            e.match(/iPhone|iPad|iPod/i) ||
            e.match(/Opera Mini/i) ||
            e.match(/IEMobile/i)
              ? "mobile"
              : "desktop";
          engine.initMouseEvents();
          game = new TrafficGame();
          game.init();
          engine.initEngine();
        };
        this.toggleFullscreen = function () {
          UTIL.playSound("clickButton");
          engine.display = engine.display == "window" ? "fullscreen" : "window";
          if (engine.display == "window") {
            if (document.cancelFullScreen) document.cancelFullScreen();
            else if (document.mozCancelFullScreen)
              document.mozCancelFullScreen();
            else if (document.webkitCancelFullScreen)
              document.webkitCancelFullScreen();
          } else {
            var e = document.getElementById("fs");
            if (e.requestFullScreen) e.requestFullScreen();
            else if (e.mozRequestFullScreen) e.mozRequestFullScreen();
            else if (e.webkitRequestFullScreen) e.webkitRequestFullScreen();
          }
        };
        this.takeScreenshot = function () {
          UTIL.playSound("clickButton");
          window.open(engine.canvasElement.toDataURL());
        };
        this.specialEvents = function (e, t) {
          if (e >= 868 && e <= 1004 && t >= 84 && t <= 116)
            engine.toggleFullscreen();
          else if (e >= 868 && e <= 1004 && t >= 44 && t <= 76)
            engine.takeScreenshot();
          else if (game.scene == "game" && game.gameOver) {
            var n = DATA.cities[game.city].menuOffset[0];
            var r = DATA.cities[game.city].menuOffset[1];
            if (e >= n + 20 && e <= n + 270 && t >= r + 50 && t <= r + 90)
              game.tweetScore();
          }
        };
        this.initMouseEvents = function () {
          function e(e) {
            var t = e.offsetX || e.layerX;
            var n = e.offsetY || e.layerY;
            engine.click.x = t;
            engine.click.y = n;
            engine.click.btn = e.which;
            engine.specialEvents(t, n);
          }
          this.canvasElement.onclick = function (t) {
            t.preventDefault();
            e(t);
            return false;
          };
          if (this.platform == "desktop") {
            this.canvasElement.onmousemove = function (e) {
              engine.hover = {
                x: e.offsetX || e.layerX,
                y: e.offsetY || e.layerY,
              };
            };
            this.canvasElement.onmouseout = function (e) {
              engine.hover = { x: false, y: false };
            };
          }
          if (this.platform == "mobile") {
            function t(e) {
              e.preventDefault();
              var t = Math.round(
                (e.targetTouches[0].pageX - engine.canvasElement.offsetLeft) /
                  engine.scaleToFit
              );
              var n = Math.round(
                (e.targetTouches[0].pageY - engine.canvasElement.offsetTop) /
                  engine.scaleToFit
              );
              engine.click.x = t;
              engine.click.y = n;
              engine.click.btn = 1;
              engine.hover = { x: t, y: n };
              game.frameCounters.touchstart = 14;
              engine.specialEvents(t, n);
              return false;
            }
            this.canvasElement.addEventListener("touchstart", t, false);
          }
        };
        this.initEngine = function () {
          window.onresize = function () {
            engine.scaleToFit = Math.min(
              window.innerWidth / engine.canvasElement.width,
              window.innerHeight / engine.canvasElement.height
            );
            engine.canvasElement.style.transformOrigin = "0 0";
            engine.canvasElement.style.webkitTransformOrigin = "0 0";
            engine.canvasElement.style.transform =
              "scale(" + engine.scaleToFit + ")";
            engine.canvasElement.style.webkitTransform =
              "scale(" + engine.scaleToFit + ")";
            var e = Math.round(
              (window.innerWidth - 1008 * engine.scaleToFit) / 2
            );
            var t = Math.round(
              (window.innerHeight - 648 * engine.scaleToFit) / 2
            );
            engine.canvasElement.style.margin =
              t + "px " + e + "px 0px " + e + "px";
          };
          window.onresize();
          if (this.platform == "mobile") {
            window.addEventListener(
              "orientationchange",
              function () {
                setTimeout("window.onresize()", 500);
              },
              false
            );
          }
          window.animFrame =
            window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            window.oRequestAnimationFrame ||
            window.msRequestAnimationFrame;
          this.scanFPS = 25;
          this.scanFrameTime = 1e3 / this.scanFPS;
          this.animationFrameTime = 0;
          this.animationFrameCounter = 0;
          this.scanFrameCounter = 0;
          this.scanInterval = false;
          if (!window.animFrame) {
            window.setInterval(function () {
              game.animationRoutine();
            }, 50);
          } else this.startAnimation();
          this.scanInterval = setInterval(function () {
            game.scanRoutine();
          }, this.scanFrameTime);
        };
        this.startAnimation = function () {
          window.animFrame(function (e) {
            if (e - engine.animationFrameTime > 40) {
              engine.animationFrameTime = e;
              game.animationRoutine();
            }
            engine.startAnimation();
          });
        };
      }
      var DATA = {
        sprites: {
          car1: "A8AAAAZCAMAAADZh4T+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABJQTFRFAP8AAKoAsvD/////3wAAV1dT5NEIwQAAAEBJREFUeNpiYGVmZoABZmZWBiQuAyqHRoARGYC4TAgAFEDmAgUI81EBAyOqZZTz0c0n4F50/2EAFhYWJBZAgAEAx9ABIYywSaQAAAAASUVORK5CYII=",
          car2: "A8AAAAZCAMAAADZh4T+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABhQTFRFAP8AsLCwAKoAsvD/kpKSV1dT////3wAAzHbFeAAAAFVJREFUeNqUkEEOACEIA8G18v8fb9EDREyMc6AMxIMIIAEFMgj7Gb5sJOKd28PLvmVcv4CDrBxU16Tq3onqipPr1BVHT1SXnqnfwWY8uZmx9Qr8AgwAkkcCWSbKQF0AAAAASUVORK5CYII=",
          car3: "A8AAAAZCAMAAADZh4T+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAA9QTFRFAP8AsvD/AKoA3wAA////WIwLcwAAAD9JREFUeNpiYGFhYYABZDatABMqYGBiRAbE8JEMA/GZUAzHlCfEp0Q/SD0TkgvBfFT3onoYMzyYmZmR2QABBgCpxQD3WQSsMAAAAABJRU5ErkJggg==",
          building1:
            "HIAAABgCAMAAAD2HdbfAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAlQTFRFZ1IA////////XHm9tQAAAAN0Uk5T//8A18oNQQAAAKtJREFUeNrs2sEKgCAQhOHV93/oAkM000ONhe0/Rw990GAupMVObF4ckzY1Xsl9MYQAqSWTB6klc4uQQrJsEVJFZg9SSJZ7A1KYUiobhYRcgvxgk/yafO+zDgnJvlyB5PCCZCpgKoCEZCqA5PCCZCqA5PCCZCqAPJFtwc+THnvck/BHWv2/rX35t1eqCyjOyEkVXtzscUOqChtU6JCUV9jDHJLaxGF8kJsAAwDN0gzofA6ppgAAAABJRU5ErkJggg==",
          building2:
            "TgAAABgCAMAAAC+C552AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAlQTFRFmWkt////////dICyygAAAAN0Uk5T//8A18oNQQAAARVJREFUeNrs3csOgkAQRUHa//9oVz4IDOiQhnasu5wQA7U4CRuZbo1NmYuIqdJ67gccuAJw2XcJDhy443CpDYrHwIEDdwQutUHxNnDgwHXDpTYo5gMHDlwfXGqDYjFw4MB1wKU2KNYGDhy4b+FSGxSNgQMHrlSDwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIED9/zZqDdw4MBtkLUuO+fk6JOCAzcW3FBdAwduULjRugYOXCW43Vf0fx44cEXgLgzQT5y8/g4eHLiL4HRtN22zLzeAA3cFnIptn6x8ZAUcuHPhpO3DroEDVwHOlru1BwfcuXB3AQYAElwi6jHPvvYAAAAASUVORK5CYII=",
          building3:
            "GAAAACoCAMAAAAo/RvTAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAlQTFRFZ1IA////////XHm9tQAAAAN0Uk5T//8A18oNQQAAAKdJREFUeNrs2zEOgCAQBEDw/4820caAUIHBY660YBqzS4yXjsakURMRSGMnFnA/ydcACqA4GlBPfgygfzqgA0x8TcMBg8MOAACIa4DCASh9QNxGA2g0aQoAKH2NBtgckEUAAGAFQFwD3Oy+BGQRAOCL1wqARtNoAKUP0GiA2IC4BgCUvkYD+DNkN0BcAwDDgWLbbcpG3f+BYi0Q0AJqBvAK2LCu5hRgADrADJcAfjNjAAAAAElFTkSuQmCC",
          building4:
            "TgAAABgCAMAAAC+C552AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAlQTFRFZ1IA////////XHm9tQAAAAN0Uk5T//8A18oNQQAAARNJREFUeNrs3csKwjAQBdDq/3+0CyFoHtXi5EE8d5kmMD2BoemiPQ5p594OHHCz4G5S5IQPHLjxcGlStsDICR84cLPg0gyt7Zt+Bw7cRLgqn+6WjYADtwhcdYGUOODATYd7u/xzPu7KyJHIuwMHbiO4lQ8k4MCBa7WbrfodOHA7wi3+yg8cOHC9TyaBz0zgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDgwIEDBw4cOHDg/gfu+dEWcODArQ9XtYstCxw4cCFwpV14ZeDAgQuBy+x6FAcOHLgQuFe7TvWBAwcuBC7Z9SsRHDhwIXC9/9YFDhy4KLgBduDAgbuShwADALRHIurzr7oWAAAAAElFTkSuQmCC",
          building5:
            "HIAAABgCAMAAAD2HdbfAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAlQTFRFmWkt////////dICyygAAAAN0Uk5T//8A18oNQQAAAJ1JREFUeNrs2kEKgDAMRNHo/Q/tohBCCl1NpDA/iy5EeeDQpKARA/UeK5zIR1pn2IfMm+oDqivmZFO1uULmOhqqJzka6oKdyRaJvpzI+tIhIe8naQXT5D72ICFvJmkFTBJITgWQTBJISFoBkwQSklbAJIF0JtdXhF83iQ2ZKqScrCqklmy7BVJItkQhhWRNFFJLTv2dBzmtWpCfAAMAygIM6DzO98cAAAAASUVORK5CYII=",
          tree: "DwAAAA6CAMAAADbe8pdAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAlQTFRFaZ5IU4gy////b13U0AAAAAN0Uk5T//8A18oNQQAAAoRJREFUeNqUVwFywzAIk/z/R68JRgjibF1uy21NZLCQBcX67SJI4vMH7vu8Tp9dr34wBOIWq/wF3usjgZ87IjLvz34F3+vfGDJCZ2QQB/wEK1xhY63YAxt8gJGoSNzTx170DEYuv18DkjjGf/HJEbzTbCCse/c7+MQaWG8o2yvFXAuJXu+RdSVvyj837ZQ3sD2HAhEqwk6Mx7SlrCI3Es8UgjtKTQ++PIqYTsnE6lkxZJWYTzxDKxyZK1OsIwucMlICyZHzVfrTnlmiyFVod4gDtK1nZEC0mL5A/9gqHvFvsFJliRLKgCpeWz8jl7RanXZ295lkE5lOaoCrMIALeYddXj2ld4G1YClLLGVZ6dql+DaKuDxiJT9IyyoOYaW8uUqmlmpVIMUNmCoo/zKRVMDSUXPZKwuCcFWhn1E5mx8MsAfmCcfccx2MVNg6SGlYg/2g5F115fgdYEnG9291yYeHvXbwcEov/+lK6x5qGchdi1Hlsm+TLp3LegHn6N3+nVsuNuc4QL1ckqXq51ZxoFtuQyfMuyKfFur0lktc16qWwnKTJ+nGkB30ZUf9jbNZ/nwhG/PMrvkC3cdNWN6mGtak2NyXYi/AFMWcjY7P8lbfGeCYaJqdiiDrVjLA9G0ZCNsB8qrThbG29Q6fIw6O2hilGl1r3M08WsVpR8Ba7DxCTjKnMz9bLIb5VK/1xTAHKtRUwNFpDC53lB8XuI9QXqT8t9IjBtjnS5dyxd4TQB0cn4aq1nhyF31SU1SepzYN9fbbKruKgrfx8emg7RRwDr1tAnQ/8kHOK4C3Yb36DX26slp/8wVldccqu/sKvDmldU1+Hdm/NpgI1n/AdbpjIJrPfwQYAJXaCdTH9+3uAAAAAElFTkSuQmCC",
          water:
            "HgAAAAQCAMAAADqHUvXAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFSDqqapXdPj/2SAAAAGlJREFUeNpiYEADjIwIkjIAMoMa5hBpCAkOp4qrBjMg04PUi3sMAwkbSvVIIcVycoMWjx0wAfIcgBkVmOaQ5EHS4xZmMC49ZIfqsM9+A5V/iUtEA+IHamdDkp2B3QEUlHiU+wibboAAAwCdeQBtLJxFtgAAAABJRU5ErkJggg==",
          concrete:
            "EgAAABICAMAAABiM0N1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFxMTE1NTUJM5ZHQAAAExJREFUeNrs0jEKACAMA8D4/08LiviAdhC5Ls0USrmMM6mlfF6UNbWUhmPu/rSo4c87kU022WSTTTbZZJNNNtlkk0022WST/ZCjKcAAL24QUZ2VpiwAAAAASUVORK5CYII=",
        },
        sounds: {
          hover: [
            2,
            ,
            0.1782,
            ,
            0.0017,
            0.54,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            0.4487,
            ,
            ,
            ,
            ,
            1,
            ,
            ,
            0.1,
            ,
            0.5,
          ],
          clickButton: [
            2,
            ,
            0.0817,
            0.4013,
            0.1998,
            0.7972,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            ,
            1,
            ,
            ,
            ,
            ,
            0.49,
          ],
          switchLight: [
            1,
            ,
            0.05,
            ,
            0.1,
            0.29,
            ,
            ,
            ,
            ,
            ,
            -0.02,
            ,
            ,
            ,
            ,
            ,
            ,
            1,
            ,
            ,
            0.1,
            ,
            0.62,
          ],
          gameOver: [
            0,
            ,
            0.3744,
            ,
            0.4312,
            0.3874,
            ,
            0.3818,
            ,
            ,
            ,
            ,
            ,
            0.4094,
            ,
            0.7409,
            ,
            ,
            1,
            ,
            ,
            ,
            ,
            0.5,
          ],
        },
        colors: [
          "000000",
          "ffffff",
          "924a40",
          "84c5cc",
          "D27DED",
          "72b14b",
          "483aaa",
          "d5df7c",
          "99692d",
          "675200",
          "ff7373",
          "606060",
          "8a8a8a",
          "b3ec91",
          "A397FF",
          "b3b3b3",
        ],
        carColors: [
          [230, 230, 50],
          [100, 150, 220],
          [230, 100, 100],
          [60, 210, 60],
          [150, 150, 150],
          [150, 130, 50],
          [170, 60, 170],
          [50, 180, 180],
        ],
        crossroadMatrix: {
          straight: { 0: [6, 10], 90: [9, 10], 180: [5, 9], 270: [5, 6] },
          right: { 0: [10, 11], 90: [9, 13], 180: [4, 5], 270: [2, 6] },
          left: {
            0: [5, 6, 10],
            90: [6, 7, 9, 10],
            180: [5, 9, 10, 14],
            270: [5, 6, 9],
          },
        },
        deniedDirections: {
          straight: { 0: 0, 90: 1, 180: 2, 270: 3 },
          right: { 0: 1, 90: 2, 180: 3, 270: 0 },
          left: { 0: 3, 90: 0, 180: 1, 270: 2 },
        },
        cityButtons: {
          paris: [0, 10, 90, 30],
          london: [100, 10, 90, 30],
          newYork: [200, 10, 90, 30],
          roma: [0, 50, 90, 30],
          sydney: [100, 50, 90, 30],
          budapest: [200, 50, 90, 30],
        },
        cities: {
          paris: {
            name: "Paris",
            map: [
              "44v33333333v66",
              "44v33333333v66",
              "44lhhhhhmhhkhh",
              "44v66666v22v33",
              "44v66666v22v33",
              "44v66666v22v33",
              "hhkhhhhhihhkhh",
              "22v33333333v11",
              "22v33333333v11",
            ],
            buildings: [
              [1, 252, 0],
              [2, 432, 0],
              [3, 912, 238],
              [4, 246, 552],
              [5, 640, 552],
            ],
            trees: [
              [300, 108],
              [380, 108],
              [460, 108],
              [540, 108],
              [270, 480],
              [350, 480],
              [430, 480],
              [590, 480],
              [670, 480],
              [844, 274],
              [844, 340],
            ],
            menuOffset: [250, 265],
          },
          london: {
            name: "London",
            map: [
              "22222v33333v66",
              "22222v33333v66",
              "hhmhhihhhhhkhh",
              "55v66666666v22",
              "55v66666666v22",
              "55v66666666v22",
              "hhkhhhhhmhhihh",
              "44v33333v44444",
              "44v33333v44444",
            ],
            buildings: [
              [1, 40, 0],
              [1, 200, 0],
              [2, 452, 0],
              [3, 912, 238],
              [4, 246, 552],
            ],
            trees: [
              [20, 108],
              [120, 108],
              [504, 108],
              [594, 108],
              [684, 108],
              [270, 484],
              [355, 484],
              [440, 484],
            ],
            menuOffset: [360, 265],
          },
          newYork: {
            name: "New York",
            map: [
              "11v33v33333v66",
              "11v33v33333v66",
              "hhj22lhhhhhkhh",
              "44v22v66666v33",
              "44v22v66666v33",
              "44v22v66666v33",
              "hhkhhihhmhhj22",
              "44v33333v33v22",
              "44v33333v33v22",
            ],
            buildings: [
              [1, 232, 0],
              [2, 452, 0],
              [3, 912, 238],
              [4, 246, 552],
              [5, 668, 552],
            ],
            trees: [
              [505, 104],
              [595, 104],
              [690, 104],
              [844, 274],
              [844, 340],
              [844, 406],
              [380, 484],
              [450, 484],
              [198, 272],
              [198, 340],
              [320, 160],
              [320, 235],
              [320, 310],
            ],
            menuOffset: [470, 265],
          },
          roma: {
            name: "Roma",
            map: [
              "44v33333v22266",
              "44v33333v22266",
              "44lhhhhhkhhmhh",
              "44v66666v44v33",
              "hhj66666v44v33",
              "11v66666v44v33",
              "11v66666v44lhh",
              "11lhhhhhj44v22",
              "11v55555v44v22",
            ],
            buildings: [
              [2, 240, 0],
              [1, 664, 0],
              [3, 912, 238],
              [5, 0, 408],
              [5, 0, 552],
            ],
            trees: [
              [300, 102],
              [380, 102],
              [460, 102],
              [710, 102],
              [790, 102],
              [260, 198],
              [350, 198],
              [440, 198],
              [264, 558],
              [354, 558],
              [444, 558],
            ],
            menuOffset: [258, 310],
          },
          sydney: {
            name: "Sydney",
            map: [
              "33333v22v33v66",
              "33333v22v33v66",
              "hhhhhkhhihhkhh",
              "44444v66666v22",
              "44444v66666v22",
              "44444v66666v22",
              "hhmhhihhhhhkhh",
              "55v11111111v44",
              "55v11111111v44",
            ],
            buildings: [
              [2, 0, 0],
              [1, 664, 0],
              [3, 912, 238],
              [4, 428, 552],
              [5, 260, 552],
            ],
            trees: [
              [20, 108],
              [100, 108],
              [180, 108],
              [260, 108],
              [380, 484],
              [475, 484],
              [570, 484],
              [665, 484],
              [844, 274],
              [844, 340],
            ],
            menuOffset: [470, 275],
          },
          budapest: {
            name: "Budapest",
            map: [
              "3333333v444v66",
              "3333333v444v66",
              "hmhhhhhkhhhkhh",
              "1v66666v444v33",
              "1v66666v444v33",
              "1v66666v444v33",
              "1lhhhhhkhhhj33",
              "1v22222v444v33",
              "1v22222v444v33",
            ],
            buildings: [
              [1, 0, 0],
              [2, 144, 0],
              [3, 912, 248],
              [3, 912, 448],
              [4, 174, 552],
            ],
            trees: [
              [30, 108],
              [220, 108],
              [305, 108],
              [390, 108],
              [200, 484],
              [285, 484],
              [370, 484],
              [844, 285],
              [844, 355],
              [844, 425],
              [844, 570],
              [30, 250],
              [30, 315],
              [30, 445],
              [30, 512],
              [30, 580],
            ],
            menuOffset: [180, 265],
          },
        },
      };
      var synth = new SfxrSynth();
      window.jsfxr = function (e) {
        synth._params.setSettings(e);
        var t = synth.totalReset();
        e = new Uint8Array(4 * (((t + 1) / 2) | 0) + 44);
        var t = 2 * synth.synthWave(new Uint16Array(e.buffer, 44), t),
          n = new Uint32Array(e.buffer, 0, 44);
        n[0] = 1179011410;
        n[1] = t + 36;
        n[2] = 1163280727;
        n[3] = 544501094;
        n[4] = 16;
        n[5] = 65537;
        n[6] = 44100;
        n[7] = 88200;
        n[8] = 1048578;
        n[9] = 1635017060;
        n[10] = t;
        for (var t = t + 44, n = 0, r = "data:audio/wav;base64,"; n < t; n += 3)
          var i = (e[n] << 16) | (e[n + 1] << 8) | e[n + 2],
            r =
              r +
              ("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
                i >> 18
              ] +
                "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
                  (i >> 12) & 63
                ] +
                "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
                  (i >> 6) & 63
                ] +
                "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[
                  i & 63
                ]);
        n -= t;
        return r.slice(0, r.length - n) + "==".slice(0, n);
      };
      var UTIL = {
        rnd: function (e) {
          return Math.floor(Math.random() * e) + 1;
        },
        rect: function (e, t, n, r, i) {
          engine.canvas.fillStyle = "#" + DATA.colors[i];
          engine.canvas.fillRect(e, t, n, r);
        },
        drawText: function (e, t, n, r, i, s) {
          if (!i) i = 14;
          if (!s) s = 1e3;
          engine.canvas.fillStyle = "#" + DATA.colors[r];
          engine.canvas.font = "bold " + i + "pt serif";
          engine.canvas.fillText(e, t, n, s);
        },
        collision: function (e, t, n, r, i, s, o, u) {
          return e + n < i || e > i + o || t + r < s || t > s + u
            ? false
            : true;
        },
        getEntryPointPixels: function (e) {
          return {
            x: e.x * 72 + [0, 45, -20, 17, 82][e.d],
            y: e.y * 72 + [0, 82, 45, -20, 17][e.d],
          };
        },
        imageBySprite: function (e) {
          var t = new Image();
          t.src =
            "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA" + DATA.sprites[e];
          return t;
        },
        hoverArea: function (e, t, n, r, i) {
          if (!n) n = 90;
          if (!r) r = 30;
          engine.canvas.beginPath();
          engine.canvas.strokeStyle =
            "#" +
            DATA.colors[
              [0, 11, 12, 15, 1, 1, 15, 12, 11][
                engine.animationFrameCounter % 9
              ]
            ];
          engine.canvas.lineWidth = 2;
          engine.canvas.rect(e, t, n, r);
          engine.canvas.stroke();
          game.hover.newElement = i ? i : e + "," + t + "," + n + "," + r;
        },
        playSound: function (e) {
          if (!Audio) return;
          var t = jsfxr(DATA.sounds[e]);
          var n = new Audio();
          n.src = t;
          n.play();
          game.lastSoundTime = Date.now();
        },
        getCarFrontArea: function (e, t, n) {
          var r;
          if (e >= 330 || e < 30) r = [t - 3, n - 15, 14, 5];
          else if (e >= 30 && e < 70) r = [t + 5, n - 14, 15, 19];
          else if (e >= 70 && e < 110) r = [t + 18, n - 3, 5, 15];
          else if (e >= 110 && e < 150) r = [t + 5, n + 4, 15, 19];
          else if (e >= 150 && e < 210) r = [t - 2, n + 18, 14, 5];
          else if (e >= 210 && e < 250) r = [t - 10, n + 4, 15, 19];
          else if (e >= 250 && e < 290) r = [t - 16, n - 3, 5, 15];
          else if (e >= 290 && e < 330) r = [t - 11, n - 14, 15, 19];
          return r;
        },
      };
      var game;
      var engine = new TrafficEngine();
      engine.init();
    </script>
  </body>
</html>
